name: Main Branch Release

on:
  push:
    branches:
      - main
      - master

env:
  DOTNET_VERSION: '10.0.x'
  IMAGE_NAME: ${{ github.event.repository.name }}
  CONTAINER_REGISTRY: ${{ vars.CONTAINER_REGISTRY_URL }}

concurrency:
  group: main-release
  cancel-in-progress: false

jobs:
  build:
    name: Build
    uses: beacontower/github-workflows/.github/workflows/dotnet-build.yml@main
    with:
      dotnet-version: ${{ vars.DOTNET_VERSION || '10.0.x' }}
      solution-path: '**/*.sln'
      build-configuration: 'Release'
      warnings-as-errors: true
      enable-nuget-cache: true
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Test
    needs: build
    uses: beacontower/github-workflows/.github/workflows/dotnet-test.yml@main
    with:
      dotnet-version: ${{ vars.DOTNET_VERSION || '10.0.x' }}
      test-project-pattern: '**/*Tests.csproj'
      build-configuration: 'Release'
      enable-code-coverage: true
      coverage-threshold: 0
      collect-test-results: true

  semantic-release:
    name: Semantic Release
    needs: [build, test]
    runs-on: ubuntu-latest
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new_release_published }}
      new-release-version: ${{ steps.semantic.outputs.new_release_version }}
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@23 \
            @semantic-release/changelog@6 \
            @semantic-release/git@10 \
            @semantic-release/github@10

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          npx semantic-release

      - name: Output release info
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "New version released: ${{ steps.semantic.outputs.new_release_version }}"
          echo "Release notes: ${{ steps.semantic.outputs.new_release_notes }}"

  container:
    name: Build & Push Container
    needs: semantic-release
    if: needs.semantic-release.outputs.new-release-published == 'true'
    permissions:
      contents: read
      security-events: write
      actions: read
    uses: beacontower/github-workflows/.github/workflows/dotnet-container.yml@main
    with:
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      image-name: ${{ github.event.repository.name }}
      version: ${{ needs.semantic-release.outputs.new-release-version }}
      registry: ${{ vars.CONTAINER_REGISTRY_URL }}
      push-image: true
      enable-security-scan: true
    secrets:
      REGISTRY_USERNAME: ${{ vars.CR_TOKEN_NAME }}
      REGISTRY_PASSWORD: ${{ secrets.AZURE_CR_TOKEN }}

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [semantic-release, container]
    if: always() && needs.semantic-release.outputs.new-release-published == 'true'

    steps:
      - name: Generate release summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.semantic-release.outputs.new-release-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.container.result }}" == "success" ]]; then
            echo "âœ… Container: ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.semantic-release.outputs.new-release-version }}" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Container: ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Container: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Container**:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.semantic-release.outputs.new-release-version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Kubernetes**:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl set image deployment/${{ env.IMAGE_NAME }} ${{ env.IMAGE_NAME }}=${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.semantic-release.outputs.new-release-version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  no-release:
    name: No Release
    needs: semantic-release
    if: needs.semantic-release.outputs.new-release-published != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: No release summary
        run: |
          echo "## â„¹ï¸ No Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No new version was released. This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "- No conventional commits since last release" >> $GITHUB_STEP_SUMMARY
          echo "- Only chore/docs commits (no version bump)" >> $GITHUB_STEP_SUMMARY
          echo "- Build/test failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use conventional commit format for releases:" >> $GITHUB_STEP_SUMMARY
          echo '- `feat:` for new features (minor version bump)' >> $GITHUB_STEP_SUMMARY
          echo '- `fix:` for bug fixes (patch version bump)' >> $GITHUB_STEP_SUMMARY
          echo '- `BREAKING CHANGE:` for breaking changes (major version bump)' >> $GITHUB_STEP_SUMMARY
