name: Pull Request Validation

on:
  pull_request:
    branches:
      - main
      - master

env:
  DOTNET_VERSION: '8.0.x'
  IMAGE_NAME: ${{ github.event.repository.name }}
  CONTAINER_REGISTRY: ${{ vars.CONTAINER_REGISTRY_URL }}

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    uses: beacontower/github-workflows/.github/workflows/dotnet-build.yml@main
    with:
      dotnet-version: ${{ vars.DOTNET_VERSION || '10.0.x' }}
      solution-path: '**/*.sln'
      build-configuration: 'Release'
      warnings-as-errors: true
      enable-nuget-cache: true
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Test
    needs: build
    uses: beacontower/github-workflows/.github/workflows/dotnet-test.yml@main
    with:
      dotnet-version: ${{ vars.DOTNET_VERSION || '10.0.x' }}
      test-project-pattern: '**/*Tests.csproj'
      build-configuration: 'Release'
      enable-code-coverage: true
      coverage-threshold: 0
      collect-test-results: true

  security:
    name: Security Scan
    uses: beacontower/github-workflows/.github/workflows/security-scan.yml@main
    with:
      dotnet-version: ${{ vars.DOTNET_VERSION || '10.0.x' }}
      enable-codeql: true
      enable-dependency-review: true
      codeql-languages: 'csharp'
      fail-on-severity: 'high'
    permissions:
      actions: read
      contents: read
      security-events: write
      pull-requests: write

  container-validation:
    name: Container Build Validation
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container (validation only)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: ${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'container-pr-validation'

  ai-review:
    name: AI Code Review
    uses: beacontower/github-workflows/.github/workflows/openai-pr-review.yml@main
    with:
      model: 'gpt-5.1'
      max-files: 20
      review-focus: 'security,performance,bestpractices,bugs'
      dotnet-context: true
      reasoning-effort: 'none'
      verbosity: 'medium'
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    permissions:
      contents: read
      pull-requests: write

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [build, test, security, container-validation, ai-review]
    if: always()

    steps:
      - name: Generate PR validation summary
        run: |
          echo "## Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Container Validation: ${{ needs.container-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- AI Review: ${{ needs.ai-review.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all required jobs passed
          if [[ "${{ needs.build.result }}" == "success" ]] && \
             [[ "${{ needs.test.result }}" == "success" ]] && \
             [[ "${{ needs.security.result }}" == "success" ]] && \
             [[ "${{ needs.container-validation.result }}" == "success" ]]; then
            echo "✅ **All validation checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some validation checks failed. Please review and fix.**" >> $GITHUB_STEP_SUMMARY
          fi
